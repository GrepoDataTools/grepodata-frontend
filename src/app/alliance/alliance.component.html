<app-search [compare]="true"></app-search>

<div style="padding: 1px; overflow-x: auto;">

  <mat-card class="decorated-card">
    <mat-card-title id="pagehead">
    </mat-card-title>
    <mat-card-content *ngIf="notFound===true">
      <div class="alert alert-warning text-center">
        <br/>
        <br/>
        <h3><strong>This alliance no longer exists!</strong> No alliance found with id {{id}} in world {{world}}</h3>
        <br/>
        <br/>
      </div>
    </mat-card-content>
    <mat-card-content *ngIf="!notFound">

	    <!--<app-advertorial *ngIf="!loadingHistory && (allianceHistoryJson.length > 10 || rank <= 20)"></app-advertorial>-->

      <div class="alliance-cards" style="" fxLayout="column" fxLayout.gt-sm="row" fxLayoutGap="5px">
        <mat-card fxFlex="25">
          <mat-card-title class="text-center">
            <h1 style='color: #304357;' class="entity-name">
              <img style="height: 25px; margin-top: -5px;" src="../../assets/images/ally_ico.png"/> {{allianceName}}
            </h1>
            <mat-spinner style="margin-left: 30px;" *ngIf="loadingInfo" strokeWidth="3" [diameter]="30"></mat-spinner>
          </mat-card-title>
          <mat-card-content [ngClass]="{'loading-overlay': loadingInfo}">
            <table class="table table-no-more alliance-info">
              <tbody>
	              <tr>
		              <th>World</th>
		              <td><div class="bg-flag flag-inline flag-{{world.substr(0,2)}}"></div>&nbsp;<a style="vertical-align: super;" routerLink="/points/{{world}}">{{worldName}}&nbsp;({{world}})</a></td>
	              </tr>
	              <tr>
	                <th>Rank</th>
	                <td><a routerLink="/ranking/alliance/{{world}}">{{rank}} <mat-icon style="opacity: 1; vertical-align: bottom;" class="hidden-xs">launch</mat-icon></a></td>
	              </tr>
	              <tr>
	                <th>Members</th>
	                <td>{{members}}</td>
	              </tr>
	              <tr>
	                <th>Points</th>
	                <td>{{points | NumberFilter}}</td>
	              </tr>
	              <tr>
	                <th>Attack points</th>
	                <td *ngIf="att">{{att | NumberFilter}}</td>
	                <td *ngIf="!att">0</td>
	              </tr>
	              <tr>
	                <th>Defence points</th>
	                <td *ngIf="def">{{def | NumberFilter}}</td>
		              <td *ngIf="!def">0</td>
	              </tr>
	              <tr *ngIf="hasIndex!=''">
	                  <th>Town intelligence</th>
	                  <td>
	                      <a (click)="openIntelTab()" class="a-link">{{hasIndex}} <i class="fa fa-arrow-circle-right"></i></a>
	                  </td>
	              </tr>
              </tbody>
            </table>

            <br/>
            <div class="container-fluid">
              <div class="row">
                <div class="col-xs-12 col-sm-12 col-md-12 col-lg-8 col-lg-offset-2 text-center">

                  <mat-expansion-panel hideToggle="true" [expanded]="compareOpened">
                    <mat-expansion-panel-header *ngIf="!compareOpened" class="gd-btn-1" (click)="addToCompare()">
                      <mat-panel-title class="gd-secondary" fxLayoutAlign="center center">
                        <mat-icon><i class="fa fa-plus"></i></mat-icon>&nbsp;&nbsp;Compare
                      </mat-panel-title>
                    </mat-expansion-panel-header>
                    <h4 *ngIf="compareOpened" fxLayoutAlign="center center">
                      Currently comparing:
                    </h4>

                    <table class="table table-no-more">
                      <tbody>
                      <tr *ngFor="let a of comparedAlliances; let i = index;">
                        <th><a routerLink="/alliance/{{world}}/{{a.id}}">{{a.name}}</a></th>
                        <td>
                          <i class="fa fa-trash" (click)="removeFromCompare(a.id, world)"></i>
                        </td>
                      </tr>
                      </tbody>
                    </table>

                    <br/>
                    <button routerLink="/compare/alliance/{{world}}" class="gd-btn-1" style="height: 40px; width: 100%; overflow: hidden; text-overflow: ellipsis;">
                      View comparison &nbsp; <i class="fa fa-arrow-circle-right"></i>
                    </button>
                  </mat-expansion-panel>

                </div>
              </div>
            </div>

          </mat-card-content>
        </mat-card>

        <mat-card fxFlex="75">
	        <div #infoTabs style="width: 100%;"></div>
          <mat-tab-group mat-stretch-tabs animationDuration="0ms" [selectedIndex]="tabsIndex"
                         (click)="cdr.detectChanges();" (selectedTabChange)="onTabClick($event)">
            <mat-tab style="padding: 20px 0; overflow: hidden;">
              <ng-template mat-tab-label>
                <mat-icon style="opacity: 1; vertical-align: bottom;">timeline</mat-icon>&nbsp;History
              </ng-template>
              <br/>
              <mat-card-title>
                <div fxLayout="row">
                  <h4 style='font-weight: 300; color: #304357;'><span class='world-title' style='color: #18BC9C;'>Alliance history</span></h4>
                  <mat-spinner style="margin-left: 30px;" *ngIf="loadingMembers" strokeWidth="3" [diameter]="30"></mat-spinner>
                </div>
              </mat-card-title>
              <mat-card-content [ngClass]="{'loading-overlay': loadingHistory}">
                <div *ngIf="historyError" class="alert alert-warning text-center alert-gd-1">
                  <h3>Unable to load history. Try again later.</h3>
                </div>
                <div class="ngx-chart-container" *ngIf="!firstRun && !historyError" (mousemove)="cdr.detectChanges();">
                  <ngx-charts-line-chart
                          [scheme]="colorScheme"
                          [results]="data_default"
                          [gradient]="gradient"
                          [xAxis]="showXAxis"
                          [yAxis]="showYAxis"
                          [legend]="showLegend"
                          [animations]="animations"
                          [showXAxisLabel]="showXAxisLabel"
                          [showYAxisLabel]="showYAxisLabel"
                          [xAxisLabel]="xAxisLabel"
                          [yAxisLabel]="yAxisLabel"
                          [autoScale]="autoScale">
                    <!--[view]="view"-->
                  </ngx-charts-line-chart>
                </div>
                <br/>
                <div *ngIf="!loadingHistory && (allianceHistoryJson.length > 25 || selectionChanged)" fxLayout="row" fxLayoutAlign="space-evenly center">
                  <div>
                    <mat-chip-list>
                      <mat-chip *ngIf="allianceHistoryJson.length >= 30" [selected]="dayRange==='30'" (click)="selectDayRange('30')">last 30 days</mat-chip>
                      <mat-chip *ngIf="allianceHistoryJson.length >= 90" [selected]="dayRange==='90'" (click)="selectDayRange('90')">last 90 days</mat-chip>
                      <mat-chip *ngIf="allianceHistoryJson.length > 30" [selected]="dayRange==='all'" (click)="selectDayRange('all')">All time</mat-chip>
                    </mat-chip-list>
                  </div>
                </div>
              </mat-card-content>
            </mat-tab>
	          <mat-tab style="overflow: hidden;">
		          <ng-template mat-tab-label>
			          <mat-icon style="opacity: 1; vertical-align: bottom;">watch_later</mat-icon>&nbsp;Activity<span class="hidden-xs">&nbsp;heatmap</span>
		          </ng-template>
		          <mat-spinner style="margin-left: 30px;" *ngIf="loadingMembers" strokeWidth="3" [diameter]="30"></mat-spinner>
		          <mat-card-content style="overflow: hidden;" *ngIf="!loadingMembers && allianceMembersData?.members.length > 0">
			          <div class="container-fluid" style="padding-right: 40px;">
				          <div class="row" style="overflow: hidden;">
					          <div #overviewLeft class="col-xs-12 col-sm-6 text-center">
						          <form class="form-inline">
							          <label style='font-weight: 700; font-size: 18px; margin: 12px; line-height: 1.1;'>
								          <span class='world-title gd-primary'>Least active player on</span>
							          </label>
							          <select #dayOfWeek id="dayOfWeek" name="dayOfWeek" [(ngModel)]="selectedDay" class="form-control mr-2" (change)="renderPlayerActivity($event)">
								          <option *ngFor="let day of daysOfWeek; let i = index;" [ngValue]="i">{{day}}</option>
							          </select>
						          </form>

						          <ngx-charts-bar-horizontal
							          [animations]="false"
							          [view]="[overviewLeft.offsetWidth-50, 60 + leastActiveDay.length * 24]"
							          [scheme]="{domain: ['#297fb9']}"
							          [results]="leastActiveDay"
							          [gradient]="false"
							          [xAxis]="true"
							          [yAxis]="true"
							          [legend]="false"
							          [showXAxisLabel]="true"
							          [showYAxisLabel]="false"
							          [roundDomains]="true"
							          [barPadding]="2"
							          [showDataLabel]="false"
							          [xAxisLabel]="'Activity'"
							          [yAxisLabel]="'Player'"
							          (select)="onPlayerClick($event)">
						          </ngx-charts-bar-horizontal>
					          </div>
					          <div #overviewRight class="col-xs-12 col-sm-6 text-center">
						          <form class="form-inline">
							          <label style='font-weight: 700; font-size: 18px; margin: 12px; line-height: 1.1;'>
								          <span class='world-title gd-primary'>Least active player at</span>
							          </label>
							          <select #hourOfDay id="hourOfDay" name="hourOfDay" [(ngModel)]="selectedHour" class="form-control mr-2" (change)="renderPlayerActivity($event)">
								          <option *ngFor="let hour of hoursOfDay; let i = index;" [ngValue]="i">{{i<10?'0':''}}{{i}}:00</option>
							          </select>
						          </form>

						          <ngx-charts-bar-horizontal
							          [animations]="false"
							          [view]="[overviewRight.offsetWidth-50, 60 + leastActiveHour.length * 24]"
							          [scheme]="{domain: ['#297fb9']}"
							          [results]="leastActiveHour"
							          [gradient]="false"
							          [xAxis]="true"
							          [yAxis]="true"
							          [legend]="false"
							          [showXAxisLabel]="true"
							          [showYAxisLabel]="false"
							          [roundDomains]="true"
							          [barPadding]="2"
							          [showDataLabel]="false"
							          [xAxisLabel]="'Activity'"
							          [yAxisLabel]="'Player'"
							          (select)="onPlayerClick($event)">
						          </ngx-charts-bar-horizontal>
					          </div>
				          </div>
			          </div>

			          <p class="gd-secondary">This tab shows player activity for the members of this alliance at the specified time.
				          Player activity is a metric that we calculate based on the attack frequency in the last 4 weeks.
				          An activity value of 1 means that the player did not send any attacks in that timeframe.
				          All times are in the same timezone as the local Grepolis server.</p>

		          </mat-card-content>
	          </mat-tab>
            <mat-tab style="overflow: hidden;">
              <ng-template mat-tab-label>
	              <mat-icon style="opacity: 1; vertical-align: bottom;">compare_arrows</mat-icon>&nbsp;
	              <span class="hidden-xs">Alliance changes</span>
	              <span class="hidden-md hidden-sm hidden-lg">Changes</span>
              </ng-template>
              <br/>
              <mat-card-title>
                <div>
                  <h4 style='font-weight: 300; color: #304357;'>
                    <span class='world-title' style='color: #18BC9C;'>Alliance changes</span>
                    <a *ngIf="playerAllianceChanges.length >= 10" routerLink="/changes/alliance/{{world}}/{{id}}" style="color: #949494; right: 20px; position: absolute;">
                      <mat-icon style="opacity: 1; vertical-align: bottom;" class="hidden-xs">launch</mat-icon> Show all changes
                    </a>
                  </h4>
                </div>
              </mat-card-title>
              <br/>
              <mat-card-content style="overflow: hidden;">
                <div *ngIf="playerAllianceChanges.length <= 0" class="alert alert-warning text-center alert-gd-1">
                  <h3>No alliance changes found.</h3>
                </div>
                <div class="table-container" *ngIf="playerAllianceChanges.length > 0">
                  <div class="table" id="player_changes_table" style="">
                    <div class="row_custom header default">
                      <div class="cell">Date</div>
                      <div class="cell">Player</div>
                      <div class="cell">Old alliance</div>
                      <div class="cell hidden-sm hidden-xs"></div>
                      <div class="cell">New alliance</div>
                      <div class="cell hidden-sm hidden-xs">Player rank</div>
                      <div class="cell hidden-md hidden-sm hidden-xs">Player points</div>
                    </div>

                    <div class="row_custom" *ngFor="let c of playerAllianceChanges; let i = index;">
                      <div class="cell">
                        {{c.date.date | Datex : "D MMM YYYY"}}
                        <br/>
                        {{c.date.date | Datex : "HH"}}:00
                      </div>

                      <div class="cell formatted-cell">
                        <a routerLink="/player/{{world}}/{{c.player_grep_id}}">
                          <span class="diff-pos" *ngIf="c.new_alliance_grep_id==id">{{c.player_name}}</span>
                          <span class="diff-neg" *ngIf="c.old_alliance_grep_id==id">{{c.player_name}}</span>
                        </a>
                      </div>

                      <div class="cell formatted-cell">
                        <a routerLink="/alliance/{{world}}/{{c.old_alliance_grep_id}}">
                          {{c.old_alliance_name}}
                        </a>
                      </div>
                      <div class="cell hidden-sm hidden-xs">
                        <span class="diff-pos" *ngIf="c.new_alliance_grep_id==id"><span class="fa fa-angle-double-right fa-2x"></span></span>
                        <span class="diff-neg" *ngIf="c.old_alliance_grep_id==id"><span class="fa fa-angle-double-right fa-2x"></span></span>
                      </div>
                      <div class="cell formatted-cell">
                        <a routerLink="/alliance/{{world}}/{{c.new_alliance_grep_id}}">
                          {{c.new_alliance_name}}
                        </a>
                      </div>

                      <div class="cell hidden-sm hidden-xs">{{c.player_rank}}</div>
                      <div class="cell hidden-md hidden-sm hidden-xs">{{c.player_points | NumberFilter}}</div>
                    </div>
                  </div>
                </div>
              </mat-card-content>
            </mat-tab>
            <mat-tab>
              <ng-template mat-tab-label>
                  <mat-icon style="opacity: 1; vertical-align: bottom;">account_balance</mat-icon>&nbsp;
	              <span class="hidden-xs">Town intelligence</span>
	              <span class="hidden-md hidden-sm hidden-lg">Intel</span>
              </ng-template>
              <app-index-alliance *ngIf="bShowIntel && hasIndex!=''" [world]="world" [key]="hasIndex" [id]="id" [embedded]="true"></app-index-alliance>
	            <h3 style="padding: 30px;" *ngIf="!bShowIntel && hasIndex!=''"><a class="a-link-dialog" style="color: #334254 !important;" (click)="bShowIntel = true;">Load town intel..</a></h3>
	            <div *ngIf="hasIndex==''" style="padding: 20px;">
		            <div class="container-fluid">
			            <div class="row">
				            <div class="col-xs-12 col-sm-8">
					            <div class="alert alert-gd-1 text-center">
						            <p>When you link an <span class="gd-primary">enemy city index</span>, we will be able to show collected intelligence about this alliance here.</p>
						            <p>You can create a new index or load an existing index shared by your alliance.</p>
						            <h3>
							            <a class="a-link-dialog" style="color: #334254 !important;" routerLink="/indexer/0">
								            Create or load an index <mat-icon style="opacity: 1; vertical-align: bottom;" class="hidden-xs">launch</mat-icon>
							            </a>
						            </h3>
					            </div>
				            </div>
				            <div class="col-sm-4 hidden-xs">
					            <img class="lib-img" style="max-width: 100%; display: block;" src="../../assets/images/indexer_town.png" alt="Grepolis town intel">
					            <h5 class="gd-secondary" style="float: right;">Images copyright © InnoGames GmbH</h5>
				            </div>
			            </div>
		            </div>
	            </div>
            </mat-tab>
          </mat-tab-group>
        </mat-card>

      </div>

      <div class="alliance-cards" fxLayout="column" fxLayout.gt-md="row" fxLayoutGap="5px">

        <mat-card fxFlex="60" fxFlex.gt-md="60" fxFlex.gt-xs="100">
          <mat-card-title>
            <div fxLayout="row">
              <h4 style='font-weight: 300; color: #304357;'><span class='world-title' style='color: #18BC9C;'>Members</span></h4>
              <mat-spinner style="margin-left: 30px;" *ngIf="loadingMembers" strokeWidth="3" [diameter]="30"></mat-spinner>
            </div>
          </mat-card-title>
          <mat-card-content [ngClass]="{'loading-overlay': loadingMembers}">
            <div *ngIf="!loadingMembers && !membersError && allianceMembersData.members.length <= 0" class="alert alert-default alert-gd-1 text-center" style="margin-top: 10px;">
              <h3>This alliance no longer has any members</h3>
            </div>
            <p *ngIf="membersError">Unable to load alliance members at this time. Try again later.</p>
            <mat-tab-group animationDuration="0ms" mat-stretch-tabs *ngIf="!loadingMembers && !membersError && allianceMembersData.members.length > 0"
                           (selectedTabChange)="activeMemberTabChange($event)" (click)="cdr.detectChanges();">
              <mat-tab>
                  <ng-template mat-tab-label>
                      <mat-icon style="opacity: 1; vertical-align: bottom;">timeline</mat-icon>&nbsp;
	                  <span class="hidden-xs">Player points</span>
	                  <span class="hidden-md hidden-sm hidden-lg">Points</span>
                  </ng-template>
                <br/>
	              <div class="table-container">
	                <div class="table" id="alliance_members_table_points" style="">
	                  <div class="row_custom header default">
		                  <div class="cell hidden-xs">#</div>
	                    <div class="cell">Rank</div>
	                    <div class="cell sticky-cell">Player</div>
	                    <div class="cell">Points</div>
	                    <div *ngFor="let date of allianceMembersData.dates; let i = index;" class="cell">
	                      {{date | Datex : "D MMM"}}
	                    </div>
	                  </div>

	                  <div class="row_custom" *ngFor="let m of allianceMembersData.members; let i = index;">
		                  <div class="cell hidden-xs">{{i+1}}</div>
	                    <div class="cell">{{m.rank}}</div>
	                    <div class="cell formatted-cell sticky-cell"><a routerLink="/player/{{world}}/{{m.id}}">{{m.name}}</a></div>
	                    <div class="cell formatted-cell">{{m.points | NumberFilter}}</div>
	                    <div *ngFor="let h of m.history.slice().reverse(); let i = index;" class="cell">
	                      <a routerLink="/points/{{world}}/{{h.date}}">
	                        <span [innerHTML]="h.points | DiffFilter"></span>
	                      </a>
	                    </div>
	                  </div>
	                </div>
	              </div>
              </mat-tab>
              <mat-tab>
                  <ng-template mat-tab-label>
                      <mat-icon style="margin-top: -8px; font-weight: 900;">⚔</mat-icon>&nbsp;
	                  <span class="hidden-xs">Attack points</span>
	                  <span class="hidden-md hidden-sm hidden-lg">Attacking</span>
                  </ng-template>
                <br/>
	              <div class="table-container">
	                <div class="table" id="alliance_members_table_att" style="">
	                  <div class="row_custom header">
		                  <div class="cell hidden-xs">#</div>
		                  <div class="cell"><span class="hidden-xs hidden-sm">Attack rank</span><span class="hidden-md hidden-lg">Rank</span></div>
	                    <div class="cell sticky-cell">Player</div>
	                    <div class="cell">Attack points</div>
	                    <div *ngFor="let date of allianceMembersData.dates; let i = index;" class="cell{{i<2 ? ' hidden-cell' : ''}}">
	                      {{date | Datex : "D MMM"}}
	                    </div>
	                  </div>

	                  <div class="row_custom" *ngFor="let m of allianceMembersData.members; let i = index;">
		                  <div class="cell hidden-xs">{{i+1}}</div>
	                    <div class="cell">{{m.att_rank}}</div>
	                    <div class="cell formatted-cell sticky-cell"><a routerLink="/player/{{world}}/{{m.id}}">{{m.name}}</a></div>
	                    <div class="cell">{{m.att | NumberFilter}}</div>
	                    <div *ngFor="let date of allianceMembersData.dates; let i = index;" class="cell{{i<2 ? ' hidden-cell' : ''}}">
	                      <span *ngFor="let h of m.history; let i = index;">
	                        <a routerLink="/points/{{world}}/{{h.date}}">
	                          <span *ngIf="h.date==date" [outerHTML]="h.att | DiffFilter"></span>
	                        </a>
	                      </span>
	                    </div>
	                  </div>
	                </div>
                </div>
              </mat-tab>
              <mat-tab>
                  <ng-template mat-tab-label>
                      <mat-icon style="margin-top: -8px; font-weight: 900;">🛡</mat-icon>&nbsp;
	                  <span class="hidden-xs">Defence points</span>
	                  <span class="hidden-md hidden-sm hidden-lg">Defending</span>
                  </ng-template>
                <br/>
	              <div class="table-container">
	                <div class="table" id="alliance_members_table_def" style="">
	                  <div class="row_custom header blue">
		                  <div class="cell hidden-xs">#</div>
		                  <div class="cell"><span class="hidden-xs hidden-sm">Defence rank</span><span class="hidden-md hidden-lg">Rank</span></div>
	                    <div class="cell sticky-cell">Player</div>
	                    <div class="cell">Defence points</div>
	                    <div *ngFor="let date of allianceMembersData.dates; let i = index;" class="cell{{i<2 ? ' hidden-cell' : ''}}">
	                      {{date | Datex : "D MMM"}}
	                    </div>
	                  </div>

	                  <div class="row_custom" *ngFor="let m of allianceMembersData.members; let i = index;">
		                  <div class="cell hidden-xs">{{i+1}}</div>
	                    <div class="cell">{{m.def_rank}}</div>
	                    <div class="cell formatted-cell sticky-cell"><a routerLink="/player/{{world}}/{{m.id}}">{{m.name}}</a></div>
	                    <div class="cell">{{m.def | NumberFilter}}</div>
	                    <div *ngFor="let date of allianceMembersData.dates; let i = index;"  class="cell{{i<2 ? ' hidden-cell' : ''}}">
	                      <span *ngFor="let h of m.history; let i = index;">
	                        <a routerLink="/points/{{world}}/{{h.date}}">
	                          <span *ngIf="h.date==date" [outerHTML]="h.def | DiffFilter"></span>
	                        </a>
	                      </span>
	                    </div>
	                  </div>
	                </div>
                </div>
              </mat-tab>
              <mat-tab>
                  <ng-template mat-tab-label>
                      <mat-icon style="opacity: 1; vertical-align: bottom;">account_balance</mat-icon>&nbsp;
	                  <span class="hidden-xs">Towns gained</span>
	                  <span class="hidden-md hidden-sm hidden-lg">Towns</span>
                  </ng-template>
                <br/>
	              <div class="table-container">
	                <div class="table" id="alliance_members_table_towns" style="">
	                  <div class="row_custom header green">
	                    <div class="cell hidden-xs">#</div>
	                    <div class="cell">Rank</div>
	                    <div class="cell sticky-cell">Player</div>
	                    <div class="cell">Towns</div>
	                    <div *ngFor="let date of allianceMembersData.dates; let i = index;" class="cell{{i<2 ? ' hidden-cell' : ''}}">
	                      {{date | Datex : "D MMM"}}
	                    </div>
	                  </div>

	                  <div class="row_custom" *ngFor="let m of allianceMembersData.members; let i = index;">
	                    <div class="cell hidden-xs">{{i+1}}</div>
	                    <div class="cell">{{m.rank}}</div>
	                    <div class="cell formatted-cell sticky-cell"><a routerLink="/player/{{world}}/{{m.id}}">{{m.name}}</a></div>
	                    <div class="cell">{{m.towns}}</div>
	                    <div *ngFor="let date of allianceMembersData.dates; let i = index;" class="cell{{i<2 ? ' hidden-cell' : ''}}">
	                      <span *ngFor="let h of m.history; let i = index;">
	                        <a routerLink="/points/{{world}}/{{h.date}}">
	                          <span *ngIf="h.date==date" [outerHTML]="h.towns | DiffFilter"></span>
	                        </a>
	                      </span>
	                    </div>
	                  </div>
	                </div>
                </div>
              </mat-tab>
            </mat-tab-group>

          </mat-card-content>
        </mat-card>

        <mat-card fxFlex="40">
          <mat-card-content>

	          <app-conquest [embedded]="true" [params]="{type: 'alliance', world: world, id: id}"></app-conquest>

          </mat-card-content>
        </mat-card>

      </div>

	    <br/>

    </mat-card-content>
  </mat-card>

</div>